require 'rake/testtask'

Rake::TestTask.new :test do |t|
  #t.pattern = 'test/*.rb'
  t.test_files = FileList['test/*.rb']
  t.warning = true
end

task :profile do
  $: << "."
  $: << "lib"
  require 'ruby-prof'
  Dir.glob("test/*.rb") do |file|
    require file
  end

  RubyProf.start
  MiniTest::Unit.new.run
  result = RubyProf.stop

  printer = RubyProf::CallTreePrinter.new result
  File.open("profile.out", "w") do |out|
    printer.print out
  end
  exit!
end

task :generate_metagrammar_data do
  $: << File.join(File.dirname(__FILE__), "lib")
  require "jetpeg"
  
  input = IO.read File.join(File.dirname(__FILE__), "lib/jetpeg/compiler/metagrammar.jetpeg")
  data = JetPEG::Compiler.metagrammar_parser[:grammar].match input, :output => :intermediate
  
  File.open(File.join(File.dirname(__FILE__), "lib/jetpeg/compiler/metagrammar.data"), "wb") do |io|
    io.write Marshal.dump(data)
  end
end